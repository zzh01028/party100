<!DOCTYPE html>

<html>

<head>
    <meta name="viewport" content="width=300,maximum-scale=5.0,user-scalable=0">
    <title>¿</title>
</head>
<script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>

<body>

    <p>要使用的图片:</p>
    <!-- <img id="portrait" src="https://github.com/zzh01028/party100/blob/main/132.jpg?raw=true" width="132px" height="132px"> -->
    <img id="portrait" src="132.jpg" width="132px" height="132px">
    <input type="file" name="file" onchange="showPreview(this)" />
    <!-- <img id="scream" src="https://github.com/zzh01028/party100/blob/main/100.png?raw=true" style="width: 180px;height: 133px; opacity: 0;"> -->
    <img id="scream" src="100.png" style="width: 180px;height: 133px; opacity: 0;">
    <p>画布:</p>
    <canvas id="myCanvas" width="300" height="300" style="border:1px solid #d3d3d3;" crossorigin="anonymous">
    您的浏览器不支持 HTML5 canvas 标签。
    </canvas>
    <p>缩放:</p>
    &nbsp;&nbsp;&nbsp;<button id="big" width="150" height="30">放大  +</button>&nbsp;&nbsp;&nbsp;<button id="small" width="150" height="60">缩小  —</button>&nbsp;&nbsp;&nbsp;
    <!-- <button id="save" width="150" height="60">保存（save）</button> -->
    <div id="box"></div>

    <script crossorigin="anonymous">
        var c = document.getElementById("myCanvas");
        var ctx = c.getContext("2d");
        var img = document.getElementById("scream");
        // img.setAttribute("crossOrigin", 'Anonymous')
        var portrait = document.getElementById("portrait");
        // portrait.setAttribute("crossOrigin", 'Anonymous')
        var downloadedImg = c;
        var imageBox = document.getElementById("box");
        // img.setAttribute('crossorigin', 'anonymous');
        // portrait.setAttribute('crossorigin', 'anonymous');
        portrait.onload = function() {
            ctx.drawImage(portrait, 0, 0, 300, 300);
            ctx.drawImage(img, 0, 0, 180, 130);
            var x = 0,
                y = 0;
            var flag = false;
            var k = 1;
            // $("canvas").mousedown(function() {

            //     flag = true;
            //     console.log(flag)
            // });

            $("canvas").mouseup(function() {

                flag = false;
                console.log(flag)
            });

            $('canvas').on('mousedown touchstart', function(e) {
                //禁用事件默认动作，如果不加，再触屏情况下，可能出现问题
                flag = true;
                console.log(flag)
                $('canvas').on('mousemove touchmove',
                    move
                );
            });

            // c.onmousemove = move;
            // c.touchmove = move;


            function move(e) {
                // console.log("flag")
                if (flag) {
                    // e.offsetX为事件相对事件源的坐标
                    x = e.offsetX - img.width / 2;
                    // e.offsetY为事件相对事件源的坐标
                    y = e.offsetY - img.height / 2;
                    console.log(x, y);
                };
                // 使用定时器，不停的清画布，重绘图片以实现类似拖拽的效果
                setInterval(function() {
                    ctx.clearRect(0, 0, 500, 400);
                    ctx.drawImage(portrait, 0, 0, 300, 300);
                    ctx.drawImage(img, x, y, 180 * k, 130 * k);
                }, 20);
            }
            $("#big").click(function() {
                k = k + 0.1;
                ctx.clearRect(0, 0, 500, 400);
                ctx.drawImage(portrait, 0, 0, 300, 300);
                ctx.drawImage(img, x, y, 180 * k, 130 * k);
            });
            $("#small").click(function() {
                k = k - 0.1;
                ctx.clearRect(0, 0, 500, 400);
                ctx.drawImage(portrait, 0, 0, 300, 300);
                ctx.drawImage(img, x, y, 180 * k, 130 * k);
            });




        }




        $("#save").click(function() {
            console.log("保存")

            var image = new Image();
            var mycanvas = document.getElementById("myCanvas");

            image.src = c.toDataURL({
                format: 'image/png',

            });
            var url = image.src.replace(/^data:image\/[^;]/, 'data:application/octet-stream');
            return image;
            window.open(url);
        });

        function showPreview(source) {
            var file = source.files[0];
            if (window.FileReader) {
                var fr = new FileReader();
                fr.onloadend = function(e) {
                    document.getElementById("portrait").src = e.target.result;
                };
                fr.readAsDataURL(file);
            }
        }
    </script>



</body>

</html>
